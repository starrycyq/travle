# Travle项目开发指南

本指南旨在为开发人员提供项目的完整开发流程、规范和最佳实践。通过遵循本指南，开发团队可以高效协作，确保代码质量和项目可维护性。

## 一、开发环境配置

### 1.1 基础环境要求

在开始开发之前，需要确保开发环境满足以下基本要求。这些要求经过实际验证，能够保证开发过程的顺畅和效率。

对于后端开发环境，开发人员需要准备Python 3.10或更高版本，推荐使用3.10版本以获得最佳的依赖兼容性。Python的安装可以通过官方网站下载安装包，或者使用conda、pyenv等版本管理工具进行安装。安装完成后，需要将Python添加到系统环境变量中，并通过运行`python --version`命令验证安装是否成功。

对于前端开发环境，Android开发需要JDK 17版本。推荐使用Microsoft OpenJDK 17，该版本经过充分测试，与Gradle 8.5和Android Gradle Plugin有良好的兼容性。JDK的安装需要配置JAVA_HOME环境变量，并确保命令行中可以正常执行java和javac命令。

此外，还需要安装Android Studio作为主要的IDE。Android Studio提供了完整的Android开发工具链，包括代码编辑器、调试器、布局设计器、性能分析器等组件。安装完成后，需要通过SDK Manager安装所需的Android SDK版本和构建工具。

### 1.2 后端环境配置

后端项目的环境配置需要遵循以下步骤，以确保所有依赖正确安装并且项目能够正常运行。

首先，进入项目根目录并导航到backend文件夹。然后创建并激活虚拟环境，虚拟环境能够隔离项目的依赖，避免与系统Python环境产生冲突。在Windows系统上，可以使用以下命令创建虚拟环境：

```bash
cd backend
python -m venv .venv
.venv\Scripts\activate
```

虚拟环境激活后，使用pip安装项目依赖。requirements.txt文件包含了所有必要的Python包，运行安装命令后等待所有依赖下载完成：

```bash
pip install -r requirements.txt
```

依赖安装完成后，需要配置环境变量。项目根目录提供了.env.example文件作为配置模板，将其复制为.env文件，并根据实际环境修改其中的配置项。主要的配置项包括SECRET_KEY用于JWT签名、API_KEY用于外部服务调用、MODEL_NAME指定使用的AI模型等。配置完成后，启动后端服务进行验证：

```bash
cd modular_api
python run_app.py
```

服务启动后，访问http://localhost:5000/api/health端点，如果返回健康检查成功的响应，说明后端环境配置正确。

### 1.3 前端环境配置

前端Android项目的环境配置相对简单，主要步骤包括项目导入、Gradle同步和构建验证。

打开Android Studio，选择"Open"或"Import Project"，然后导航到android-app文件夹并选择该项目。Android Studio会自动识别Gradle项目结构并开始同步。同步过程中，IDE会下载项目依赖并配置构建环境，这个过程可能需要几分钟时间，取决于网络状况。

Gradle同步完成后，需要确保SDK配置正确。通过Android Studio的File菜单进入Settings/Preferences，选择Appearance & Behavior → System Settings → Android SDK，检查SDK路径和版本是否正确。然后选择Build → Rebuild Project进行构建验证。

如果构建成功，可以在命令行中使用以下命令生成调试APK：

```bash
cd android-app
.\gradlew.bat assembleDebug
```

生成的APK文件位于app/build/outputs/apk/debug/app-debug.apk目录下。

## 二、项目架构详解

### 2.1 前端架构设计

Android前端采用MVVM架构结合Clean Architecture原则进行设计，这种架构能够有效地分离关注点，提高代码的可测试性和可维护性。项目的代码结构清晰地体现了这一设计理念，将不同职责的代码组织在不同的层级中。

数据层位于com.travle.app.data包下，负责所有数据相关的操作。这一层进一步划分为多个子包：api子包包含Retrofit网络接口定义和NetworkModule网络模块；auth子包包含AuthManager认证管理器，负责用户认证状态的维护；database子包包含Room数据库相关的DAO类和数据实体；model子包定义了在API通信中使用的数据模型；repository子包则封装了数据访问逻辑，为上层提供统一的数据接口。

UI层位于com.travle.app.ui包下，负责用户界面的呈现和交互逻辑的处理。screens子包包含了应用的所有页面，每个页面都是一个独立的Composable函数；theme子包定义了应用的视觉主题，包括颜色、字体和样式；viewmodel子包包含了与页面绑定的ViewModel，负责处理UI状态和业务逻辑。

这种分层架构的优势在于，每一层都有明确的职责边界，层与层之间通过接口进行通信，降低了耦合度。当需要修改某一层的实现时，只要接口保持不变，就不会影响到其他层。

### 2.2 后端架构设计

后端采用Flask框架，遵循模块化的设计原则，将不同功能的代码组织在独立的蓝图中。项目结构清晰，便于维护和扩展。

modular_api是后端的主应用目录，包含了所有的API实现代码。routes子目录定义了所有的API端点，每个端点都对应一个蓝图：auth.py处理用户认证相关接口；chat.py实现AI聊天功能；community.py提供社区功能接口；guide.py处理攻略相关操作；main.py包含基础功能接口；preference.py管理用户偏好设置；roadtrip.py实现自驾游规划功能；search.py提供搜索服务；xiaohongshu.py负责小红书攻略的采集和处理。

services子目录包含了业务逻辑实现，这些服务被路由层调用以完成具体的业务操作。auth.py提供认证相关的业务逻辑；cache.py实现缓存管理；database.py处理数据库操作；model.py封装了AI模型的调用；scraper.py实现网页爬取功能；vector.py处理向量数据库操作。

utils子目录包含了各种工具类，为整个应用提供通用的功能支持。config.py读取和管理配置；database_optimizer.py优化数据库性能；monitoring.py提供性能监控功能；validation.py实现参数验证逻辑。

这种架构设计使得后端具有良好的扩展性，新增功能只需要添加新的路由和服务，而不影响现有代码的稳定性。

## 三、编码规范

### 3.1 后端编码规范

后端Python代码需要遵循以下编码规范，以确保代码的一致性和可读性。

命名规范方面，变量和函数使用小写字母加下划线的方式（snake_case），例如user_name、get_user_info。类名使用大驼峰命名法（PascalCase），例如UserManager、ApiResponse。常量全部使用大写字母，单词之间用下划线分隔，例如MAX_RETRY_COUNT、DEFAULT_PAGE_SIZE。

代码格式方面，严格遵循PEP 8规范，使用4个空格进行缩进。行宽限制在120个字符以内，超过限制的代码需要进行换行处理。函数和类之间使用两个空行分隔，同一函数内的逻辑块之间使用一个空行分隔。

注释规范方面，复杂的业务逻辑需要添加注释说明，注释使用中文编写。对于公开的API函数，需要使用docstring描述函数功能、参数和返回值。避免添加无意义的注释，保持注释的简洁和准确。

类型注解方面，推荐为函数参数和返回值添加类型注解，提高代码可读性和IDE支持。例如：

```python
from typing import Optional, List, Dict

def get_user_by_id(user_id: int) -> Optional[Dict[str, any]]:
    """根据用户ID获取用户信息"""
    pass
```

### 3.2 前端编码规范

Android Kotlin代码需要遵循以下编码规范，这些规范结合了Kotlin语言特性和Android开发最佳实践。

命名规范方面，变量和函数使用驼峰命名法（camelCase），例如userName、getUserInfo。类名和枚举使用大驼峰命名法，例如UserRepository、ScreenState。布局资源文件使用小写字母加下划线，例如activity_main.xml、user_item.xml。

代码格式方面，使用Android Studio默认的代码格式化快捷键（Ctrl+Alt+L）进行格式化。属性声明顺序遵循： companion object → private val → public val → override val。函数顺序遵循：生命周期函数 → 公开函数 → 私有函数。

Compose规范方面，Composable函数使用@Composable注解标记，函数名使用PascalCase。状态变量使用remember和mutableStateOf进行管理，事件处理函数以on开头命名，例如onButtonClick。参数较少的Composable函数写在同一行，参数较多的函数每个参数占一行。

空安全方面，尽可能使用非空类型和lateinit，避免使用?.和!!操作符。函数返回可能为空的值时，明确使用?标记返回类型。

## 四、功能开发流程

### 4.1 新功能开发流程

新功能的开发需要遵循标准的流程，确保功能的完整性和代码质量。

第一步是需求分析，明确功能的目标和范围。与产品经理或项目负责人沟通，确定功能的具体需求和验收标准。对于复杂功能，需要编写详细的功能说明文档，包括用户场景、业务流程、接口定义等。

第二步是接口设计，如果是涉及前后端交互的功能，需要先确定API接口的定义。设计接口时需要考虑：请求方法和路径、请求参数和格式、响应数据和错误码。接口设计完成后，更新API文档（backend/api_specs/travle_api.yaml）。

第三步是后端实现，根据接口设计实现后端逻辑。实现过程中需要注意：参数验证、错误处理、日志记录。代码完成后进行自测，确保接口功能正常。

第四步是前端实现，根据设计稿和接口文档实现前端功能。前端开发遵循组件化原则，将复杂页面拆分为可复用的组件。实现完成后进行功能测试，确保与设计一致。

第五步是集成测试，将前后端联调，测试完整的业务流程。测试覆盖正常流程和异常场景，确保功能的健壮性。

### 4.2 API开发规范

API开发需要遵循统一的规范，以保证接口的一致性和可维护性。

路径命名方面，使用复数名词表示资源集合，例如/users、/guides。使用HTTP方法区分操作类型：GET用于查询、POST用于创建、PUT用于更新、DELETE用于删除。路径层级不超过三级，例如/api/community/notes/{id}。

请求格式方面，POST和PUT请求使用JSON格式提交数据。请求头包含Content-Type: application/json。对于需要认证的接口，在请求头中携带JWT Token，格式为Authorization: Bearer <token>。

响应格式方面，所有响应使用统一的JSON格式：

```json
{
    "status": "success",
    "message": "操作成功",
    "data": {
        // 业务数据
    }
}
```

错误响应格式如下：

```json
{
    "status": "error",
    "message": "错误描述",
    "code": "ERROR_CODE"
}
```

状态码使用标准HTTP状态码：200表示成功、201表示创建成功、400表示请求参数错误、401表示未认证、403表示无权限、404表示资源不存在、500表示服务器错误。

## 五、测试指南

### 5.1 后端测试

后端测试主要使用pytest框架，测试文件位于各模块的test目录下。

单元测试针对单个函数或方法进行测试，验证其功能的正确性。测试时需要覆盖正常情况和异常情况，确保函数对各种输入都能正确处理。

集成测试针对API端点进行测试，验证整个请求处理流程的正确性。使用pytest的fixture机制管理测试数据和测试环境。

运行所有测试的命令：

```bash
cd backend/modular_api
pytest
```

运行指定测试文件的命令：

```bash
pytest test_modular_api.py
```

### 5.2 前端测试

前端测试使用JUnit进行单元测试，测试文件位于app/src/test目录下。

ViewModel测试验证业务逻辑的正确性，使用假数据模拟各种场景。Repository测试验证数据访问逻辑，使用Mock或Fake替代真实数据源。

运行所有测试的命令：

```bash
cd android-app
.\gradlew.bat test
```

运行指定测试类的命令：

```bash
.\gradlew.bat test --tests "com.travle.app.data.repository.PreferencesRepositoryTest"
```

## 六、构建与部署

### 6.1 前端构建

Android应用的构建使用Gradle工具，支持调试构建和发布构建两种模式。

调试构建生成未优化的APK，包含调试信息，适用于开发和测试阶段：

```bash
cd android-app
.\gradlew.bat assembleDebug
```

发布构建生成经过优化的APK，适用于生产环境发布：

```bash
.\gradlew.bat assembleRelease
```

构建产物位于app/build/outputs/apk/{debug|release}目录下。

### 6.2 Docker部署

项目支持使用Docker进行容器化部署，部署文件位于backend目录下。

首先构建Docker镜像：

```bash
cd backend
docker build -t travle-backend .
```

然后使用docker-compose启动服务：

```bash
docker-compose up -d
```

docker-compose.yml文件配置了服务的基本参数，包括端口映射、环境变量挂载、数据卷挂载等。根据实际部署环境，可能需要修改这些配置。

对于生产环境，建议使用以下最佳实践：使用docker-compose.prod.yml替代默认配置；配置外部数据库替代SQLite；配置日志收集系统；设置资源限制和健康检查。

## 七、常见问题

### 7.1 环境配置问题

在配置开发环境时，可能会遇到一些常见问题，以下是这些问题的解决方案。

Python虚拟环境激活失败的问题，通常是因为执行策略限制。在Windows PowerShell中，需要先执行`Set-ExecutionPolicy RemoteSigned`来允许执行脚本，然后重新激活虚拟环境。

Gradle同步超时的问题，可能是因为网络原因导致依赖下载缓慢。可以尝试配置国内镜像源，或者使用代理服务器。在gradle.properties文件中添加阿里云Maven镜像配置。

端口被占用的问题，后端服务默认使用5000端口，如果端口被占用会启动失败。可以修改.env文件中的PORT配置项，或者停止占用端口的进程。

### 7.2 构建问题

Android构建过程中可能遇到的问题和解决方案。

JDK版本不匹配的问题，需要确保使用JDK 17版本。可以使用`java -version`命令检查当前JDK版本。如果版本不匹配，需要下载并配置正确的JDK版本。

内存不足的问题，Gradle构建需要足够的堆内存。可以在gradle.properties文件中增加堆内存限制，例如设置org.gradle.jvmargs=-Xmx2048m。

依赖冲突的问题，不同模块可能依赖同一库的不同版本。可以在build.gradle.kts中使用resolutionStrategy来解决冲突。

## 八、参考资源

项目开发过程中可以参考以下资源，这些资源包含了相关技术的详细文档和最佳实践。

Flask官方文档提供了Web框架的完整指南，包括路由、模板、数据库集成等内容。地址：https://flask.palletsprojects.com/

Kotlin官方文档是学习Kotlin语言的最佳资源，涵盖了语言基础、协程、DSL等高级特性。地址：https://kotlinlang.org/docs/home.html

Jetpack Compose官方文档提供了声明式UI开发的完整指南，包括Compose组件、状态管理、性能优化等内容。地址：https://developer.android.com/jetpack/compose/docs

Android Architecture Components官方文档介绍了MVVM架构组件的使用，包括ViewModel、LiveData、Room等。地址：https://developer.android.com/topic/libraries/architecture

OpenAPI规范文档定义了RESTful API的设计标准，项目中的API文档遵循此规范。地址：https://spec.openapis.org/oas/latest.html
